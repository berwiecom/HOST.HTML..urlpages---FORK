<!DOCTYPE html>
<html>
<head>
    <title>URL Pages Editor</title>
    <style>
        @import url('https://fonts.googleapis.com/css?family=Lato');

        * {
            margin: 0;
            box-sizing: border-box;
            vertical-align: top;
        }

        body {
            font-family: Lato, sans-serif;
            height: 100vh;
            background: #222;
        }

        html, body {
            height: 100%;
        }

        textarea, iframe {
            border: 1px solid;
        }

        #topbar {
            width: 100%;
            background: #181818;
            padding: 5px;
            height: 50px;
        }
        #topbar h3, #topbar h5 {
            color: #eee;
            margin: 0;
            margin-left: 15px;
            width: 25%;
        }
        #topbar h3 {
            margin-top: 1px;
        }

        #topbar button, #topbar a {
            background: #282828;
            user-select: none;
            float: right;
            color: #e9e9e9;
            text-decoration: none;
            font-size: 15px;
            padding: 8px 15px;
            border: 3px solid #555;
            display: inline-block;
            border-radius: 3px;
            margin-left: 5px;
            margin-top: 2px;
            cursor: pointer;
        }
        /*#topbar form button:first-of-type { margin-right: 15px; }*/
        #topbar button:hover, #topbar a:hover {
            background: #333;
        }

        form {
            display: inline;
        }

        .share-menu {
            padding: 10px;
            width: 200px;
            background: #181818;
            z-index: 99999999999;
            border-radius: 3px;
            position: fixed;
            right: 5px;
            top: 48px;
            display: none;
        }

        .share-menu.open {
            display: block;
        }

        .share-menu button, .share-menu a {
            width: 100%;
            display: block;
            float: initial;
        }



        #textboxes {
            height: calc(40% - 50px);
            width: 100%;
            resize: vertical;
            overflow: auto;
            border: 4px solid #292929;
            background: #222;
            /*padding: 0 15px;*/
            padding-right: 8px;
        }

        textarea, #html, #css, #javascript {
            resize: none;
            width: calc(33.3333% - (10px / 3));
            height: 100%;
            display: inline-block;
            border: 3px solid #555;
            border-top: 0;
        }

        iframe {
            width: 100%;
            height: 60%;
        }

        .editor-left #textboxes {
            display: inline-block;
            resize: horizontal;
            width: 35%;
            height: calc(100% - 50px);
            padding-right: 0;
        }

        .editor-left #html, .editor-left #css, .editor-left #javascript {
            height: calc(33.3333% - (10px / 3));
            display: block;
            width: 100%;
        }

        .editor-left iframe {
            display: inline-block;
            width: 64.5%;
            height: calc(100% - 45px);
        }
    </style>
</head>

<body onload="initialize()">

<div id="topbar">
    <!-- Seemingly random attributes necessary for TinyUrl to accept the request -->

    <div class="share-menu">
        <form action="http://tinyurl.com/create.php" method="get" target="_blank">
            <input type="hidden" id="source" name="source" value="indexpage">
            <input type="hidden" name="url" id="url" />
            <button onclick="setCodeUrl()">Short Link to Editor</button>
            <button onclick="setViewUrl()">Short Link to Preview</button>
        </form>
        <a id="getLinkLink" href="" target="_blank">Long Link to Preview</a>
    </div>

    <!--<button onclick="showCopyCodePrompt()">Copy Code</button>-->
    <!--<button><a id="downloadLink" href="" target="_blank" download="export.html">Download Code</a></button>-->

    <a class="shareBtn" onclick="toggleShareMenu()">Links</a>

    <a onclick="toggleView()">Toggle View</a>
    <a href="#">Fork</a>
    <a href="#">Save</a>
    <a href="#">Share</a>
    <a href="#">Like</a>

    <h3 contenteditable>Document Title</h3>
    <h5>by <span contenteditable>Author Name</span></h5>
</div>

<div id="textboxes" onkeyup="update()">
    <div id="html">HTML</div>
    <div id="css">/* CSS */</div>
    <div id="javascript">// Javascript</div>
</div>

<iframe></iframe>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.5/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.5/mode-html.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.5/theme-tomorrow_night.js"></script>
<script src=""></script>
<script src=""></script>
<script src=""></script>
<script src=""></script>

<script>
    function b64EncodeUnicode(str) {
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
            return String.fromCharCode(parseInt(p1, 16))
        }))
    }

    function b64DecodeUnicode(str) {
        return decodeURIComponent(Array.prototype.map.call(atob(str), function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        }).join(''))
    }

    /* Return the HTML string for the page */
    function getHTML(data) {
        if (!window.data) window.data = {};
        // Generate an HTML page from the contents of each <textarea>
        var pageData = `<!DOCTYPE html><head><style>${ data["css"] }</style><script>${ data["js"] }</scr${ '' }ipt></head><body>${ data["html"] }</bo${ '' }dy>`;

        return pageData;
    }

    /* Return a link to view the page */
    function getViewLink(pageData) {
        return `${ location.protocol }//${ location.host }/#${ b64EncodeUnicode(pageData) }`;
    }

    function gett (url, cb) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url);
        xhr.onload = function() {
            if (xhr.status === 200) {
                if (cb && typeof cb == 'function') cb(xhr.responseText);
            } else {
                console.log('Request failed', xhr.status);
            }
        };
        xhr.send();
    }

    /* Set the TinyUrl form hidden 'url' field to the view URL */
    function setViewUrl() {
        if (!window.data) window.data = {};
        if (!window.data.html) window.data.html = '';
        if (!window.data.css) window.data.css = '';
        if (!window.data.js) window.data.js = '';

        window.data.html = htmlEditor.getValue();
        window.data.css = cssEditor.getValue();
        window.data.js = jsEditor.getValue();

        var html = encodeURIComponent(getHTML(data));

        // Update the URL for the "Short Link" button
        document.getElementById("url").value = getViewLink(html);
    }

    function toggleShareMenu () {
        var isOpen = document.querySelector('.shareBtn').className.includes('open');
        if (isOpen) document.querySelectorAll('.shareBtn, .share-menu').forEach(itm => itm.classList.remove('open'));
        else document.querySelectorAll('.shareBtn, .share-menu').forEach(itm => itm.classList.add('open'));
    }

    function toggleView () {
        var isEditorLeft = document.body.className.includes('editor-left');
        if (isEditorLeft) document.body.classList.remove('editor-left');
        else document.body.classList.add('editor-left');
    }


    /* Set the TinyUrl form hidden 'url' field to the code URL */
    function setCodeUrl() {
        document.getElementById("url").value = window.location.href;
    }

    /* Show a prompt with the HTML page data so the user can copy the code */
//    function showCopyCodePrompt() {
//        var data = {
//            "css" : document.getElementById("css").value,
//            "js" : document.getElementById("javascript").value,
//            "html" : document.getElementById("html").value
//        };
//
//        var html = getHTML(data);
//
//        window.prompt("Copy to clipboard: ", html)
//    }

    /* Run once when the page is loaded */
    function initialize() {
        // Get page data from the URL and load it into the boxes
        if (window.location.hash) {
            var b64  = window.location.hash.slice(1);
            var json = b64DecodeUnicode(b64);
            window.data = JSON.parse(json);
        }

        if (!window.data) window.data = {};

        window.htmlEditor = ace.edit("html");
        htmlEditor.setTheme("ace/theme/tomorrow_night");
        htmlEditor.session.setMode("ace/mode/html");
        htmlEditor.session.setUseWrapMode(true);
        if (data["html"]) htmlEditor.session.setValue(data["html"]);

        window.cssEditor = ace.edit("css");
        cssEditor.setTheme("ace/theme/tomorrow_night");
        cssEditor.session.setMode("ace/mode/css");
        cssEditor.session.setUseWrapMode(true);
        if (data["css"]) cssEditor.session.setValue(data["css"]);

        window.jsEditor = ace.edit("javascript");
        jsEditor.setTheme("ace/theme/tomorrow_night");
        jsEditor.session.setMode("ace/mode/javascript");
        jsEditor.session.setUseWrapMode(true);
        if (data["js"]) jsEditor.session.setValue(data["js"]);

        update();
    }


    /* Run each time a key is pressed on a text box */
    function update() {
//        var data = {
//            "css" : document.getElementById("css").value,
//            "js" : document.getElementById("javascript").value,
//            "html" : document.getElementById("html").value
//        };

        if (!window.data) window.data = {};
        if (!window.data.html) window.data.html = '';
        if (!window.data.css) window.data.css = '';
        if (!window.data.js) window.data.js = '';

        window.data.html = htmlEditor.getValue();
        window.data.css = cssEditor.getValue();
        window.data.js = jsEditor.getValue();

        var html = encodeURIComponent(getHTML(data));

        // Save encoded page data to the URL
        window.location.hash = "#" + b64EncodeUnicode(JSON.stringify(data));

        // Update the URL for the "Get Link" button
        document.getElementById("getLinkLink").href = getViewLink(html);

        // Update the download link
        // document.getElementById("downloadLink").href = `data:text/html,${html}`

        // Update the <iframe> to display the generated page
        // Todo: Update with a > 8-bit safe solution for updates
        window.frames[0].location.replace(`data:text/html,${html}`);
    }

</script>
</body>
</html>
